@model List<BangLuong.ViewModels.BaoCaoTongHopCongViewModel>

@{
    ViewData["Title"] = "Báo Cáo Tổng Hợp Công";
}

<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h4 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-calendar-check"></i> Báo Cáo Tổng Hợp Công
            </h4>
        </div>

        <div class="card-body">

            <form asp-action="BaoCaoTongCong" method="get" class="mb-4">
                <div class="row">
                    <div class="col-md-3">
                        <label>Tháng</label>
                        <select name="thang" class="form-control">
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i" selected="@(i == ViewBag.Thang ? "selected" : null)">Tháng @i</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label>Năm</label>
                        <select name="nam" class="form-control">
                            @for (int i = DateTime.Now.Year - 2; i <= DateTime.Now.Year + 1; i++)
                            {
                                <option value="@i" selected="@(i == ViewBag.Nam ? "selected" : null)">@i</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label>&nbsp;</label><br />
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Xem Báo Cáo
                        </button>

                        @if (Model != null && Model.Any())
                        {
                            <button type="button" class="btn btn-success" onclick="exportExcel()">
                                <i class="fas fa-file-excel"></i> Xuất Excel
                            </button>
                        }
                    </div>
                </div>
            </form>

            @if (Model != null && Model.Any())
            {
                <div class="alert alert-info">
                    <strong>Kỳ báo cáo:</strong> Tháng @ViewBag.Thang/@ViewBag.Nam
                    <span class="float-right"><strong>Tổng số nhân viên:</strong> @Model.Count</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="dataTable">
                        <thead class="thead-light">
                            <tr>
                                <th>STT</th>
                                <th>Phòng Ban</th>
                                <th>Mã NV</th>
                                <th>Họ Tên</th>
                                <th>Chức Vụ</th>
                                <th class="text-center">NC Chuẩn</th>
                                <th class="text-center">NC Thực Tế</th>
                                <th class="text-center">Nghỉ Phép</th>
                                <th class="text-center">TC Ngày Thường</th>
                                <th class="text-center">TC Cuối Tuần</th>
                                <th class="text-center">TC Ngày Lễ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int stt = 1;
                                string currentPhongBan = "";
                            }
                            @foreach (var item in Model)
                            {
                                @if (currentPhongBan != item.PhongBan && !string.IsNullOrEmpty(item.PhongBan))
                                {
                                    currentPhongBan = item.PhongBan;
                                    <tr class="table-secondary font-weight-bold">
                                        <td colspan="11">@currentPhongBan</td>
                                    </tr>
                                }
                                <tr>
                                    <td>@stt</td>
                                    <td>@item.PhongBan</td>
                                    <td>@item.MaNV</td>
                                    <td>@item.HoTen</td>
                                    <td>@item.ChucVu</td>
                                    <td class="text-center">@item.NgayCongChuan.ToString("0.##")</td>
                                    <td class="text-center">@item.NgayCongThucTe?.ToString("0.##")</td>
                                    <td class="text-center">@((item.SoNgayNghiPhep == null) ? "0.00" : item.SoNgayNghiPhep.Value.ToString("0.##"))</td>
                                    <td class="text-center">@((item.SoGioTangCaNgayThuong == null) ? "0.00" : item.SoGioTangCaNgayThuong.Value.ToString("0.##"))</td>
                                    <td class="text-center">@((item.SoGioTangCaCuoiTuan == null) ? "0.00" : item.SoGioTangCaCuoiTuan.Value.ToString("0.##"))</td>
                                    <td class="text-center">@((item.SoGioTangCaNgayLe == null) ? "0.00" : item.SoGioTangCaNgayLe.Value.ToString("0.##"))</td>
                                </tr>
                                stt++;
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Vui lòng chọn Tháng/Năm và nhấn "Xem Báo Cáo" để hiển thị dữ liệu.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function exportExcel() {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("ExportBaoCaoTongCong", "BaoCao")';

            const thangInput = document.createElement('input');
            thangInput.type = 'hidden';
            thangInput.name = 'thang';
            thangInput.value = '@ViewBag.Thang';
            form.appendChild(thangInput);

            const namInput = document.createElement('input');
            namInput.type = 'hidden';
            namInput.name = 'nam';
            namInput.value = '@ViewBag.Nam';
            form.appendChild(namInput);

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        $(document).ready(function() {
            $('#dataTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json"
                },
                "pageLength": 25,
                "order": [[1, "asc"], [3, "asc"]]
            });
        });
    </script>
}
